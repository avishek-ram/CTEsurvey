<!DOCTYPE html>
<html>
<head>
<!-- Auther Shivanesh Lal copyright 2020 --------
      Author Avishek Ram Updated on 03/06/2022
				-->

</head>
<body>

<?php
 //Create connection
   $host        = "host = localhost";
   $port        = "port = 5432";
   $dbname      = "dbname = moodle";
   $credentials = "user = postgres";

   $conn = pg_connect( "$host $port $dbname $credentials"  );
   if(!$conn) {
      echo "Error : Unable to open database\n";
   } else {
     // echo "Opened database successfully\n";
   }

$u = $USER->username;
$fn = $USER->firstname;
$ln = $USER->lastname;
$email = $USER->email;

//get recourds from DB
$sql = "SELECT DISTINCT c.fullname, c.id, c.startdate, ra.roleid, c.visible, c.shortname
	FROM mdl_course AS c JOIN mdl_context AS ctx ON c.id = ctx.instanceid 
	JOIN mdl_role_assignments AS ra ON ra.contextid = ctx.id 
	JOIN mdl_user AS u ON u.id = ra.userid 
	WHERE u.username = '$u'";

$email =  $USER->email;
$allowed = array('fnu.ac.fj', 'student.fnu.ac.fj');

// Make sure the address is valid
if (filter_var($email, FILTER_VALIDATE_EMAIL))
{
    $explodedEmail = explode('@', $email);
    $domain = array_pop($explodedEmail);

    if ( ! in_array($domain, $allowed))
    {
		echo '<div class="alert alert-danger">
	 <strong>Dear, '.$fn. ' '.$ln.' your email address '.$email.' is not a valid FNU email address. Please update your email address according to the Universities policy by clicking 
	 <a href="/user/edit.php">here</a> or visit your nearest ICT helpdesk if you do not have an official email ID.<br/><br/>Thanks<br/>Moodle Team.</strong></div>';
	 
/*	 echo ("<SCRIPT LANGUAGE='JavaScript'>
        window.alert('Please update your e-mail to offical FNU e-mail !!')
        window.location.href='httpss://elearn.fnu.ac.fj/user/edit.php'
        </SCRIPT>");
	 */
	 }
}
?>
<h4>Course Overview</h4>

<ul class="nav nav-pills mb-3" id="pills-tab" role="tablist">
 <li class="nav-item">
    <a class="nav-link active" id="pills-2022-tab" data-toggle="pill" href="#pills-2022" role="tab" aria-controls="pills-2022" aria-selected="true">2022</a>
  </li>
  <li class="nav-item">
    <a class="nav-link" id="pills-2021-tab" data-toggle="pill" href="#pills-2021" role="tab" aria-controls="pills-2021" aria-selected="true">2021</a>
  </li>
  <li class="nav-item">
    <a class="nav-link" id="pills-2020-tab" data-toggle="pill" href="#pills-2020" role="tab" aria-controls="pills-2020" aria-selected="false">2020</a>
  </li>
  <li class="nav-item">
    <a class="nav-link" id="pills-All-courses-tab" data-toggle="pill" href="#pills-All-courses" role="tab" aria-controls="pills-All-courses" aria-selected="false">All courses</a>
  </li>
  <li>
  <a class="nav-link" href="https://elearn-archive.fnu.ac.fj" target="_blank">old Moodle</button></a>
  </li>

<label></a>
  </li>
  <form action="https://elearn.fnu.ac.fj/course/search.php" id="coursesearch" method="get" class="form-inline my-2 my-lg-0">
    <fieldset class="coursesearchbox invisiblefieldset">
        <input id="coursesearchbox" name="search" type="text"  placeholder="Search Course" class="form-control" required>
        <button class="btn btn-secondary" type="submit">Search</button>
	</form>
</ul>




<div style="height:400px;width:100%;overflow:scroll;overflow-x:hidden;overflow-y:scroll;">
<div class="tab-content" id="pills-tabContent">

<div class="tab-pane show active" id="pills-2022" role="tabpanel" aria-labelledby="pills-2022-tab">
<?php  
global $DB;

//global $DB;
  $getRecord = "$sql"."AND shortname like '%2022%' ORDER BY startdate DESC";
   $result = pg_query($conn, $getRecord);
   
  $surveyquery = pg_query($conn, "SELECT * FROM mdl_survey_dashboard");
   //$result = $DB->get_records_sql('$getRecord');
   //$j = pg_num_rows($result);
   $k=0;
    //var_dump($result);
	if (pg_num_rows($result)> 0) {
    // output data of each row
	$row = pg_fetch_all($result);
  $survey_rows = pg_fetch_all($surveyquery);

  $semester_end_status_sur = false;
  $mid_sem_status_sur = false;
  $quarter_end_status_sur = false;
  $trimester_end_status_sur = false;

  foreach($survey_rows as $sur)
  {
    if($sur["surveytype"] == "1" && $sur["surveystatus"] == "1"){
      $semester_end_status_sur = true;
    }
    else if($sur["surveytype"] == "2" && $sur["surveystatus"] == "1"){
      $mid_sem_status_sur = true;
    }
    else if($sur["surveytype"] == "3" && $sur["surveystatus"] == "1"){
      $quarter_end_status_sur = true;
    }
    else if($sur["surveytype"] == "4" && $sur["surveystatus"] == "1"){
      $trimester_end_status_sur = true;
    }

  }
		while($k < pg_num_rows($result)) {
			$i =  $CFG->wwwroot . "/course/view.php?id=".$row[$k]["id"];

    //avishek start
    $shortname = trim($row[$k]["shortname"]);
    $termcode = substr($shortname, -2);
    $row[$k]["termcode"] =  $termcode;

    //survey types
    //1 is semester end survey
    //2 is mid sem survey
    //3 is quarter end survey
    //4 is trimester end survey
    if($termcode == "20"){//sem
      if($semester_end_status_sur == true){
        $row[$k]["has_survey"] = true;
        $row[$k]["survey_type"] = 1;
      }
      if($mid_sem_status_sur == true){
        $row[$k]["has_survey"] = true;
        $row[$k]["survey_type"] = 2;
      }
    }
    else if($termcode == "25"){
      if($quarter_end_status_sur == true){
        $row[$k]["has_survey"] = true;
        $row[$k]["survey_type"] = 3;
      }
    }
    else if($termcode == "30"){
      if($trimester_end_status_sur == true){
        $row[$k]["has_survey"] = true;
        $row[$k]["survey_type"] = 4;
      }
    }

    //end
		echo "<div class ='lnk'>";
		echo "<a href='$i'>";
		//var_dump($row);
    $params = array ("course_id" => $row[$k]["id"]);
    $course_mapping = $DB->get_record_select('fnu_course_code_mapping', "courseid = :course_id", $params);
    $course_code = $course_mapping ?trim($course_mapping-> coursecode) :  $row[$k]["id"];
		echo "<img src='images/".$row[$k]["roleid"].".png' width='25' height='25' /> " . $row[$k]["fullname"]. "</a>";
    if($row[$k]["has_survey"] && $row[$k]["roleid"] == "5" && !$DB->record_exists('fnu_survey_attempts', array('user_id' =>  $USER->id, 'course' => $course_code, 'survey_type' => strval($row[$k]["survey_type"])))){
      $thislink = '/testmoodle/moodle/local/termsurvey/index.php?surveytype=' . $row[$k]["survey_type"] . "&course_id=" . $row[$k]["id"];
      echo "<a class='btn btn-sm btn-primary ml-2 survy_btn' href='{$thislink}'>Attempt Survey</a>";  
    }
    echo "<br><hr>";
		echo "</div>";
		$k++;
	}
	
} else {
    echo "No Courses Found";
} ?>
  </div>
<div class="tab-pane fade" id="pills-2021" role="tabpanel" aria-labelledby="pills-2021-tab">
<?php  
global $DB;

//global $DB;
  $getRecord = "$sql"."AND shortname like '%2021%' ORDER BY startdate DESC";
   $result = pg_query($conn, $getRecord);
   //$result = $DB->get_records_sql('$getRecord');
   //$j = pg_num_rows($result);
   $k=0;
    //var_dump($result);
	if (pg_num_rows($result)> 0) {
    // output data of each row
	$row = pg_fetch_all($result);
		while($k < pg_num_rows($result)) {
			$i =  "/course/view.php?id=".$row[$k]["id"];
		echo "<div class ='lnk'>";
		echo "<a href='$i'>";
		//var_dump($row);
		echo "<img src='images/".$row[$k]["roleid"].".png' width='25' height='25' /> " . $row[$k]["fullname"]. "</a><br><hr>";
		echo "</div>";
		$k++;
	}
	
} else {
    echo "No Courses Found";
} ?>
  </div>
  <div class="tab-pane fade" id="pills-2020" role="tabpanel" aria-labelledby="pills-2020-tab">
  <?php
   $getRecord = "$sql"."AND shortname like '%2020%' ORDER BY startdate DESC";
   $result = pg_query($conn, $getRecord);
   //$j = pg_num_rows($result);
   $k=0;
    //var_dump($result);
	if (pg_num_rows($result)> 0) {
    // output data of each row
	$row = pg_fetch_all($result);
 
		while($k < pg_num_rows($result)) {
			$i =  "/course/view.php?id=".$row[$k]["id"];
		echo "<div class ='lnk'>";
		echo "<a href='$i'>";
		//var_dump($row);
		echo "<img src='images/".$row[$k]["roleid"].".png' width='25' height='25' /> " . $row[$k]["fullname"]. "</a><br><hr>";
		echo "</div>";
		$k++;
	}
	
} else {
    echo "No Courses Found";
}
  ?>
  </div>
  
  <div class="tab-pane fade" id="pills-All-courses" role="tabpanel" aria-labelledby="pills-All-courses-tab">
  <?php $result = pg_query($conn, $sql);
   //$j = pg_num_rows($result);
   $k=0;
    //var_dump($result);
	if (pg_num_rows($result)> 0) {
    // output data of each row
	$row = pg_fetch_all($result);
  
		while($k < pg_num_rows($result)) {
			$i =  "/course/view.php?id=".$row[$k]["id"];
		echo "<div class ='lnk'>";
		echo "<a href='$i'>";
		//var_dump($row);
		echo "<img src='images/".$row[$k]["roleid"].".png' width='25' height='25' /> " . $row[$k]["fullname"]. "</a>"; 
    echo"<br><hr>";
		echo "</div>";
		$k++;
	}
	
} else {
    echo "No Courses Found";
}?>
</div>
</div>
</div>

<?php
require_once($CFG->dirroot .'/mod/forum/lib.php');

                if (! $newsforum = forum_get_course_forum($SITE->id, 'news')) {
                    print_error('cannotfindorcreateforum', 'forum');
                }

                // Fetch news forum context for proper filtering to happen.
                $newsforumcm = get_coursemodule_from_instance('forum', $newsforum->id, $SITE->id, false, MUST_EXIST);
                $newsforumcontext = context_module::instance($newsforumcm->id, MUST_EXIST);

                $forumname = format_string($newsforum->name, true, array('context' => $newsforumcontext));
                echo html_writer::link('#skipsitenews',
                    get_string('skipa', 'access', core_text::strtolower(strip_tags($forumname))),
                    array('class' => 'skip-block skip'));

                // Wraps site news forum in div container.
                echo html_writer::start_tag('div', array('id' => 'site-news-forum'));

                if (isloggedin()) {
                    $SESSION->fromdiscussion = $CFG->wwwroot;
                    $subtext = '';
                    if (\mod_forum\subscriptions::is_subscribed($USER->id, $newsforum)) {
                        if (!\mod_forum\subscriptions::is_forcesubscribed($newsforum)) {
                            $subtext = get_string('unsubscribe', 'forum');
                        }
                    } else {
                        $subtext = get_string('subscribe', 'forum');
                    }
                    echo $OUTPUT->heading($forumname);
                    $suburl = new moodle_url('/mod/forum/subscribe.php', array('id' => $newsforum->id, 'sesskey' => sesskey()));
                    echo html_writer::tag('div', html_writer::link($suburl, $subtext), array('class' => 'subscribelink'));
                } else {
                    echo $OUTPUT->heading($forumname);
                }

                forum_print_latest_discussions($SITE, $newsforum, $SITE->newsitems, 'plain', 'p.modified DESC');

                // End site news forum div container.
                echo html_writer::end_tag('div');

                echo html_writer::tag('span', '', array('class' => 'skip-block-to', 'id' => 'skipsitenews'));

//$conn->close();
?> 

 </html>

  
